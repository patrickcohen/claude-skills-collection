<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-1000-pipeline-orchestrator - State Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../shared/css/diagram.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ln-1000-pipeline-orchestrator</h1>
            <p class="subtitle">Meta-Orchestrator Pipeline - State Diagram</p>
        </header>

        <div class="info-box">
            <h3>Workflow Overview</h3>
            <ul>
                <li><strong>Purpose:</strong> Read kanban board, drive Stories through 4-stage pipeline (300 -> 310 -> 400 -> 500) in parallel via TeamCreate</li>
                <li><strong>Concurrency:</strong> Max 3 Stories processed simultaneously (fresh worker per stage)</li>
                <li><strong>Model Routing:</strong> All stages = Opus 4.6. Effort: Stage 0,3 = high | Stage 1,2 = medium</li>
                <li><strong>Lead Role:</strong> Delegate mode only - coordination, kanban updates, squash-merge. No code writing</li>
                <li><strong>Auto Merge:</strong> After quality gate PASS, squash-merge to develop</li>
                <li><strong>Error Recovery:</strong> Quality cycle limit (2), validation retry (1), rework escalation (3), crash resume via checkpoint</li>
                <li><strong>Lead Recovery:</strong> Phase 0 restores all state from .pipeline/state.json on restart (full schema persisted every heartbeat)</li>
                <li><strong>Git Worktree:</strong> Every worker gets its own worktree with named feature branch (feature/{id}-{slug})</li>
                <li><strong>Dependencies:</strong> Stories with Depends On fields are scheduled after prerequisites complete (dependency guard in Phase 4)</li>
                <li><strong>Keepalive:</strong> Stop hook prevents lead exit, TeammateIdle hook prevents worker idle during stages</li>
                <li><strong>Fresh Per Stage:</strong> Each stage = new worker with clean context. Prevents context exhaustion in long pipelines</li>
                <li><strong>Project Awareness:</strong> Lead reads CLAUDE.md (project_brief) + Story ORCHESTRATOR_BRIEF markers (story_briefs) for tech context</li>
            </ul>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color color-discovery"></div>
                <span>Discovery/Setup</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-loop"></div>
                <span>Execution Loop</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-decision"></div>
                <span>Decision Point</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-action"></div>
                <span>Stage Execution</span>
            </div>
            <div class="legend-item">
                <div class="legend-color color-output"></div>
                <span>Output/Report</span>
            </div>
        </div>

        <div class="diagram-section">
            <h2>Pipeline Orchestrator Flow</h2>
            <div class="mermaid">
stateDiagram-v2
    [*] --> Phase0_Recovery

    state "Phase 0: Recovery Check" as Phase0_Recovery {
        [*] --> CheckState
        CheckState: Check .pipeline/state.json exists
        state HasState <<choice>>
        CheckState --> HasState
        HasState --> RestoreState: exists AND complete=false
        HasState --> FreshStart: not exists OR complete=true
        RestoreState: Restore all state variables from state.json
        RestoreState --> ValidateCheckpoints
        ValidateCheckpoints: Read checkpoint-*.json, verify consistency
        ValidateCheckpoints --> ResumeWorkers
        ResumeWorkers: Task(resume: agentId) or respawn per story
        ResumeWorkers --> JumpPhase4: Resume event loop
        FreshStart: Proceed to Phase 1
    }

    Phase0_Recovery --> Phase1_Discovery: Fresh start
    Phase0_Recovery --> Phase4_Loop: Recovery resume

    state "Phase 1: Discovery & Kanban Parsing" as Phase1_Discovery {
        [*] --> ParseKanban
        ParseKanban: Auto-discover kanban_board.md
        ParseKanban --> ProjectBrief
        ProjectBrief: Read project CLAUDE.md, extract project_brief
        ProjectBrief --> ExtractStories
        ExtractStories: Extract Stories by status section
        ExtractStories --> DetectTasks
        DetectTasks: Detect task presence per Story
        DetectTasks --> BuildQueue
        BuildQueue: Priority: To Review > To Rework > In Progress > Todo > Backlog
        BuildQueue --> ExtractDeps
        ExtractDeps: Extract dependencies per Story (depends_on)
        ExtractDeps --> StoryBriefs
        StoryBriefs: Parse ORCHESTRATOR_BRIEF from each Story
        StoryBriefs --> DetectRemote
        DetectRemote: Detect remote type (github/gitlab/unknown)
        DetectRemote --> ShowPlan
        ShowPlan: Display plan with project tech context
    }

    Phase1_Discovery --> Phase2_Questions

    state "Phase 2: Pre-flight Questions" as Phase2_Questions {
        [*] --> ScanQuestions
        ScanQuestions: Scan Story descriptions for ambiguities
        ScanQuestions --> ClassifyQ
        state ClassifyQ <<choice>>
        ClassifyQ --> AskBusiness: Business questions found
        ClassifyQ --> SkipQuestions: No business questions
        AskBusiness: Batch AskUserQuestion (ONE prompt)
        AskBusiness --> StoreAnswers
        StoreAnswers: Store answers for workers
        SkipQuestions --> StoreAnswers
    }

    Phase2_Questions --> Phase3_TeamSetup

    state "Phase 3: Team Setup" as Phase3_TeamSetup {
        [*] --> VerifySettings
        VerifySettings: Verify settings.local.json (bypassPermissions)
        VerifySettings --> InstallHooks
        InstallHooks: Install Stop + TeammateIdle hooks
        InstallHooks --> InitState
        InitState: Write .pipeline/state.json (complete=false, full schema)
        InitState --> CreateTeam
        CreateTeam: TeamCreate(pipeline-{date})
        note right of CreateTeam: Workers spawned by Phase 4 spawn loop
    }

    Phase3_TeamSetup --> Phase4_Loop

    state "Phase 4: Execution Loop (heartbeat-driven)" as Phase4_Loop {
        [*] --> CheckDeps
        CheckDeps: Check dependency guard (depends_on satisfied?)
        state DepResult <<choice>>
        CheckDeps --> DepResult
        DepResult --> CreateWorktree: Unblocked story
        DepResult --> SkipBlocked: All deps unresolved
        CreateWorktree: git worktree add -b feature/{id}-{slug}
        CreateWorktree --> AssignStages
        SkipBlocked: Skip to next candidate or wait
        SkipBlocked --> DeadlockCheck
        state DeadlockCheck <<choice>>
        DeadlockCheck --> TurnEnds: Some stories can still unblock
        DeadlockCheck --> AllDone: All remaining blocked on PAUSED (deadlock)
        AssignStages: Assign stages to workers
        AssignStages --> TurnEnds
        TurnEnds: Lead turn ends
        TurnEnds --> StopHook
        StopHook: Stop hook fires (exit 2 if active)
        StopHook --> Heartbeat
        Heartbeat: HEARTBEAT — new agentic loop
        Heartbeat --> CheckMessages
        state CheckMessages <<choice>>
        CheckMessages --> Stage0Done: "Stage 0 tasks created"
        CheckMessages --> Stage1Done: "Stage 1 GO"
        CheckMessages --> Stage2Done: "Stage 2 Done"
        CheckMessages --> Stage3Result: "Stage 3 verdict"
        CheckMessages --> ErrorHandler: Error/crash
        CheckMessages --> NoMessages: No worker messages
        NoMessages: Brief status output
        NoMessages --> TurnEnds

        Stage0Done: Verify tasks exist in kanban
        Stage0Done --> ShutdownSpawn1: Shutdown + spawn fresh for Stage 1
        ShutdownSpawn1 --> TurnEnds

        Stage1Done: Verify Story=Todo
        Stage1Done --> ShutdownSpawn2: Shutdown + spawn fresh for Stage 2
        ShutdownSpawn2 --> TurnEnds

        Stage2Done: Verify Story=To Review
        Stage2Done --> ShutdownSpawn3: Shutdown + spawn fresh for Stage 3
        ShutdownSpawn3 --> TurnEnds

        state Stage3Result <<choice>>
        Stage3Result --> SquashMerge: PASS/CONCERNS/WAIVED
        Stage3Result --> QualityFail: FAIL

        SquashMerge: Squash-merge to develop, shutdown worker
        SquashMerge --> SpawnNext
        state SpawnNext <<choice>>
        SpawnNext --> AssignStages: Queue not empty
        SpawnNext --> AllDone: Queue empty

        QualityFail --> CheckCycles
        state CheckCycles <<choice>>
        CheckCycles --> ReenterStage2: cycles < 2
        CheckCycles --> Escalate: cycles >= 2
        ReenterStage2: Shutdown + spawn fresh for Stage 2 fix
        ReenterStage2 --> TurnEnds
        Escalate: Ask user, pause Story
        Escalate --> SpawnNext

        ErrorHandler: Resume/re-spawn worker (checkpoint)
        ErrorHandler --> TurnEnds

        AllDone: All Stories processed
    }

    Phase4_Loop --> Phase5_Cleanup

    state "Phase 5: Cleanup & Self-Verification" as Phase5_Cleanup {
        [*] --> MarkComplete
        MarkComplete: Write state.json complete=true
        MarkComplete --> VerifyDoD
        VerifyDoD: Self-verify against Definition of Done
        VerifyDoD --> GenerateReport
        GenerateReport: Finalize pipeline report (docs/tasks/reports/)
        GenerateReport --> ShowSummary
        ShowSummary: Pipeline summary table to user
        ShowSummary --> ShutdownWorkers
        ShutdownWorkers: shutdown_request to all workers
        ShutdownWorkers --> DeleteTeam
        DeleteTeam: TeamDelete
        DeleteTeam --> RemoveWorktrees
        RemoveWorktrees: git worktree remove (all story worktrees)
        RemoveWorktrees --> EnsureDevelop
        EnsureDevelop: git checkout develop
        EnsureDevelop --> CleanPipeline
        CleanPipeline: Delete .pipeline/ directory
        CleanPipeline --> ReportDone
        ReportDone: Report results to user
    }

    Phase5_Cleanup --> [*]
            </div>
        </div>

        <div class="diagram-section">
            <h2>Per-Story State Machine</h2>
            <div class="mermaid">
stateDiagram-v2
    [*] --> QUEUED

    QUEUED --> STAGE_0: Backlog (no tasks)
    QUEUED --> STAGE_1: Backlog (tasks exist)
    QUEUED --> STAGE_2: Todo/ToRework Story
    QUEUED --> STAGE_3: ToReview Story

    state "Stage 0: Task Planning (ln-300)" as STAGE_0
    state "Stage 1: Validation (ln-310)" as STAGE_1
    state "Stage 2: Execution (ln-400)" as STAGE_2
    state "Stage 3: Quality Gate (ln-500)" as STAGE_3

    STAGE_0 --> STAGE_1: Tasks created
    STAGE_0 --> PAUSED: Creation failed

    STAGE_1 --> STAGE_2: GO verdict
    STAGE_1 --> PAUSED: NO-GO (retry exhausted)

    STAGE_2 --> STAGE_3: All tasks Done
    STAGE_2 --> PAUSED: Task stuck 3+ reworks

    STAGE_3 --> DONE: PASS / CONCERNS / WAIVED
    STAGE_3 --> STAGE_2: FAIL (cycles < 2)
    STAGE_3 --> PAUSED: FAIL (cycles >= 2)

    PAUSED --> STAGE_0: User resolves (planning)
    PAUSED --> STAGE_1: User resolves (validation)
    PAUSED --> STAGE_2: User resolves (execution)

    DONE --> [*]: Merged to develop, worker shutdown
            </div>
        </div>

        <div class="diagram-section">
            <h2>Team Communication</h2>
            <div class="mermaid">
sequenceDiagram
    participant U as User
    participant L as Pipeline Lead (Opus)
    participant W as Story Workers (Opus, effort per stage)
    participant K as Kanban Board

    L->>K: Parse kanban board
    K-->>L: Priority queue (with deps)
    L->>U: Business questions (batch)
    U-->>L: Answers

    L->>W: Spawn PROJ-42-s2: Execute Stage 2
    L->>W: Spawn PROJ-55-s0: Execute Stage 0

    Note over W: PROJ-55-s0: ln-300 running...
    W-->>L: Stage 0 COMPLETE (5 tasks)
    L->>W: shutdown PROJ-55-s0
    L->>K: Verify tasks exist
    L->>W: Spawn PROJ-55-s1: Execute Stage 1

    Note over W: PROJ-42-s2: ln-400 running...
    Note over W: PROJ-55-s1: ln-310 running...

    W-->>L: PROJ-55 Stage 1 GO
    L->>W: shutdown PROJ-55-s1
    L->>K: Update: PROJ-55 → Todo
    L->>W: Spawn PROJ-55-s2: Execute Stage 2

    W-->>L: PROJ-42 Stage 2 COMPLETE
    L->>W: shutdown PROJ-42-s2
    L->>K: Verify: PROJ-42 = To Review
    L->>W: Spawn PROJ-42-s3: Execute Stage 3

    Note over W: PROJ-42-s3: ln-500 running...

    W-->>L: PROJ-42 Stage 3 PASS (92)
    L->>W: shutdown PROJ-42-s3
    L->>K: Update: PROJ-42 → Done
    L->>L: Squash-merge to develop
            </div>
        </div>

        <div class="diagram-section">
            <h2>Worker Lifecycle (Fresh Per Stage)</h2>
            <div class="mermaid">
stateDiagram-v2
    [*] --> SPAWNED

    SPAWNED --> EXECUTING: Lead sends "Execute Stage N"

    state "EXECUTING" as EXECUTING
    note right of EXECUTING: Running ln-300/310/400/500\nvia Skill tool\nOne stage per worker

    EXECUTING --> REPORTING: Skill completes

    state "REPORTING" as REPORTING
    note right of REPORTING: SendMessage to lead\n"Stage N COMPLETE/ERROR"

    REPORTING --> SHUTDOWN: Lead sends shutdown_request

    EXECUTING --> CRASHED: No completion message

    state "Crash Detection & Recovery" as CRASHED {
        [*] --> SuspiciousIdle
        SuspiciousIdle: TeammateIdle WITHOUT completion
        SuspiciousIdle --> DiagnosticProbe
        DiagnosticProbe: Lead sends "Status check"
        DiagnosticProbe --> Recovered: Worker responds
        DiagnosticProbe --> ConfirmedCrash: Still idle, no response
        Recovered --> [*]
        ConfirmedCrash --> TryResume: crash_count ≤ 1
        ConfirmedCrash --> Escalate: crash_count ≥ 2
        TryResume: Task(resume: agentId) from checkpoint
        TryResume --> ResumeOK: Resume succeeds
        TryResume --> CheckpointFallback: Resume fails
        CheckpointFallback: New worker + checkpoint context
        ResumeOK --> [*]
        CheckpointFallback --> [*]
        Escalate: PAUSED + ask user
    }

    SHUTDOWN --> [*]: shutdown approved\nLead spawns fresh worker for next stage
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            stateDiagram: { defaultRenderer: 'dagre-wrapper' },
            sequence: { mirrorActors: false }
        });
    </script>
</body>
</html>
