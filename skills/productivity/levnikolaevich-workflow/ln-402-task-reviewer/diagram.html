<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-402-task-reviewer - State Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../shared/css/diagram.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ln-402-task-reviewer</h1>
            <p class="subtitle">Task Reviewer with Agent Review - State Diagram</p>
        </header>
        <div class="info-box">
            <h3>Overview</h3>
            <ul>
                <li><strong>Purpose:</strong> Review task implementation (To Review -> Done/To Rework)</li>
                <li><strong>Isolation:</strong> Fresh eyes pattern - loads context independently from task ID only</li>
                <li><strong>Agent Review:</strong> codex-review || gemini-review parallel for second opinion</li>
                <li><strong>Side-Effects:</strong> Creates [BUG] tasks for issues found outside task scope</li>
            </ul>
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph TD
    Start([Start: Review Task]) --> S1

    subgraph S1 [Step 1: Receive Task]
        S1A[Get task ID from orchestrator<br/>Isolated context - NO other data]
    end

    S1 --> S2

    subgraph S2 [Step 2: Read Context]
        S2A[Load task from Linear/File<br/>independently]
        S2A --> S2B[Load parent Story<br/>AC, requirements]
        S2B --> S2C[Detect type:<br/>implementation / test / refactor]
    end

    S2 --> S3

    subgraph S3 [Step 3: Review Checks - 8 Criteria]
        S3A[Architecture + Technical Approach]
        S3A --> S3B[No hardcoded creds/URLs/magic numbers]
        S3B --> S3C[Error handling + logging levels]
        S3C --> S3D[Comments WHY not WHAT<br/>Naming conventions<br/>Docs + tests updated]
    end

    S3 --> S4

    subgraph S4 [Step 4: AC Validation - 4 Criteria]
        S4A[AC Completeness<br/>happy + error + edge cases]
        S4A --> S4B[AC Specificity<br/>exact HTTP codes, timing, messages]
        S4B --> S4C[Task Dependencies<br/>N uses only 1..N-1]
        S4C --> S4D[Database Creation<br/>only tables in Story scope]
    end

    S4 --> S5

    subgraph S5 [Step 5: Side-Effect Bug Detection]
        S5A[Scan touched files for<br/>pre-existing bugs]
        S5A --> S5B[Check adjacent code<br/>security, deprecated APIs]
        S5B --> S5C{Bugs found?}
        S5C -->|Yes| S5D[Create BUG tasks<br/>in same Story]
        S5C -->|No| S5E[Continue]
        S5D --> S5E
    end

    S5 --> S6

    subgraph S6 [Step 6: Agent Review - Parallel Aggregation]
        S6A[Prepare prompt<br/>code_review.md + task/story]
        S6A --> S6B[codex-review<br/>gpt-5.3-codex]
        S6A --> S6C[gemini-review<br/>gemini-3-flash-preview]
        S6B --> S6D[Aggregate suggestions<br/>Dedup by area+issue]
        S6C --> S6D
        S6D --> S6E{Both<br/>failed?}
        S6E -->|Yes| S6F[Self-Review fallback]
        S6F --> S6G[Claude validates each<br/>ACCEPT / REJECT]
        S6E -->|No| S6G
        S6G --> S6H[Feed accepted into verdict]
    end

    S6 --> S7

    subgraph S7 [Step 7: Decision]
        S7A{Issues found?}
        S7A -->|Nits only| S7B[Apply minor fixes<br/>-> Done]
        S7B --> S7D[Commit all changes<br/>git add + commit with task ID]
        S7A -->|Issues / critical agent findings| S7C[Comment: why + how to fix<br/>-> To Rework]
    end

    S7 --> S8

    subgraph S8 [Step 8: Update]
        S8A[Set status in Linear]
        S8A --> S8B{Done?}
        S8B -->|Yes| S8C[Remove task from kanban<br/>Done = Stories only]
        S8B -->|No| S8D[Move to To Rework section]
        S8C --> S8E[Post review comment<br/>+ agent summary + BUG list]
        S8D --> S8E
    end

    S8 --> End([End: Task Reviewed])

    classDef discovery fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef review fill:#FFF9C4,stroke:#F57C00,stroke-width:2px
    classDef agent fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef decision fill:#FFE0B2,stroke:#E64A19,stroke-width:2px
    classDef action fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    classDef error fill:#FFCDD2,stroke:#C62828,stroke-width:2px

    class S1A,S2A,S2B,S2C discovery
    class S3A,S3B,S3C,S3D,S4A,S4B,S4C,S4D,S5A,S5B,S5C,S5D,S5E review
    class S6A,S6B,S6C,S6D,S6E,S6F,S6G,S6H agent
    class S7A decision
    class S7B,S7D,S8A,S8B,S8C,S8E action
    class S7C,S8D error
            </div>
        </div>
        <footer>
            <p>ln-402-task-reviewer v5.0.0 | 8 steps | Fresh eyes isolation | Agent Review (codex || gemini parallel)</p>
        </footer>
    </div>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' } });
    </script>
</body>
</html>
